\usepackage[latin1]{inputenc}
\usepackage{stmaryrd} % For boxy Maths symbols
\usepackage{wasysym} % for circly Maths symbols
\usepackage{epsdice} % for dice symbols
\usepackage{dingbat} % for curly section symbols
\usepackage{appendix}
\usepackage{geometry} % changes page borders
	\geometry{margin=50pt}
\usepackage{svg}
\usepackage{alltt}
	\svgsetup{width=\textwidth}
\usepackage{tabularx}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{epigraph} % part quotes
\usepackage{makeidx}
\usepackage[english]{babel}
\usepackage{multicol}
\usepackage{graphicx}
\usepackage{etoolbox}
\usepackage{titlesec}
\usepackage{needspace}
\usepackage{tikz}
	\usetikzlibrary{mindmap,trees}
\usepackage{pifont}
\usepackage{colortbl}
\usepackage[poster]{tcolorbox}
\tcbuselibrary{breakable,raster}
\tcbset{enhanced,drop shadow east,colback=white,breakable,arc=6mm,outer arc=1mm}

%%%%%%%%%% Section Headers %%%%%%%%%%

%%% Allow quotes under part headers
\makeatletter
\let\old@endpart\@endpart
\renewcommand\@endpart[1][]{%
\begin{quote}#1\end{quote}%
\old@endpart}
\makeatother

\titleformat{\chapter}[frame]
{\normalfont}
{\filright
\footnotesize
\enspace SECTION \thesection\enspace}
{8pt}
{\Huge\filcenter\bfseries}

\newcommand{\chapnumfont}{
  \fontsize{144}{0}
  \selectfont
}

%%%%%%%%%% Encounter Numbers
\newcounter{encnum}
\setcounter{encnum}{1}
\newcommand{\encsymbol}{\ding{168}}
\newcommand{\encnum}{\ifnumcomp{\value{encnum}}{=}{1}{$A$}{\arabic{encnum}}\encsymbol\addtocounter{encnum}{1}}

\newcommand{\headingtype}{CHAPTER}

\newcommand{\sidepic}[2]{
	\needspace{3cm}\begin{wrapfigure}{O}{.#1\textwidth}
\includegraphics[width=.#1\textwidth]{images/#2}
\end{wrapfigure}
}

\colorlet{chapnumcol}{black!55}

\titleformat{\chapter}[display]
{\bfseries}
{\begin{tikzpicture}
  \node[minimum width=\textwidth, text=black!25, fill=black!25, inner sep=1, outer sep=0, anchor=south] (rectinit) {\huge CHAPTER};
  \node[minimum width=.8\textwidth, text=white, inner sep=1, outer sep=0, anchor=south west, text width=.8\textwidth, align=right] at (rectinit.south west) (chapname) {\huge \headingtype~~};
  \node[minimum width=.2\textwidth, inner sep=0, outer sep=0, anchor=south west, text width=.2\textwidth, align=left] at (chapname.south east) {\chapnumfont\textcolor{chapnumcol}{\thechapter}};
\end{tikzpicture}}
{0pt}
{\Huge}

\titleformat{\section}[frame]
{\needspace{18em}\normalfont}
{\filright
\footnotesize
\enspace SECTION \thesection\enspace}
{8pt}
{\Large\bfseries\filcenter}

\titleformat{\subsection}{\needspace{2em}\large\bfseries}{}{1em}{}[\rule{.9\linewidth}{.2pt}]
%
\titleformat{\subsubsection}
{\normalfont\normalsize\bfseries}{\thesubsubsection}{1em}{}

%\titleformat{\paragraph}[runin]
%{\normalfont\normalsize\bfseries}{\theparagraph}{1em}{}
%
%\titleformat{\subparagraph}[runin]
%{\normalfont\normalsize\bfseries}{\thesubparagraph}{1em}{}

%\titlespacing*{\chapter}
%{0pt}{50pt}{40pt}
%\titlespacing*{\section}
%{0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex}
%\titlespacing*{\subsection}
%{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
%\titlespacing*{\subsubsection}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
%\titlespacing*{\paragraph}
%{0pt}{3.25ex plus 1ex minus .2ex}{1em}
%\titlespacing*{\subparagraph} {\parindent}{3.25ex plus 1ex minus .2ex}{1em}

%%%%% Character Sheet Tracker

		\newcounter{track}
		\setcounter{track}{18}
		\newcommand{\tracker}{\center\noindent\arabic{track}\addtocounter{track}{-1}\vspace{.54cm}

		}

\newcommand{\npc}[2]{\needspace{12em}\vspace{.38cm}  #1 #2 \vspace{.18cm}}
\newcommand{\NPC}[4]{\needspace{4em}\vspace{.38cm} #1 #2

\hspace{.5cm}\textbf{Personality:} #3

\hspace{.5cm}\textbf{Mannerism:} #4

}
\newcommand{\G}{\opposition} % groups
\newcommand{\M}{\mars} % male
\newcommand{\F}{\venus} % female
\newcommand{\E}{\mercury} % blood casters
\newcommand{\C}{\taurus} % creature
\newcommand{\N}{\leftmoon} % nura
\newcommand{\U}{\fullmoon} % undead

\newcommand{\character}[1]{\needspace{12em}\vspace{.38cm} \ding{70} #1 \ding{70}\vspace{.18cm}}

\newcommand{\Character}[3]{\needspace{4em}\vspace{.38cm} \ding{70} #1 \ding{70}

\hspace{.5cm}\textbf{Personality:} #2

\hspace{.5cm}\textbf{Mannerism:} #3

}

\newcommand{\monster}[1]{\needspace{4em}\vspace{.38cm} \ding{70} #1 \ding{70}\vspace{.18cm}}

%%%%%%%%%%%%%%%%%%%% TOGGLES %%%%%%%%%%%%%%%%%%%%

\newtoggle{verbose}
\settoggle{verbose}{true}

\iftoggle{verbose}{
	\setcounter{tocdepth}{1}
	\setcounter{secnumdepth}{1}
}

\newcounter{enc}
\newcounter{list}
\newcounter{spelllevel}
\setcounter{spelllevel}{0}


%%%%%%%%%%%%%%%%%%%% LAYOUT %%%%%%%%%%%%%%%%%%%%
\makeindex
\raggedbottom

\newcommand{\currentsphere}{magic}
\newcommand{\sphere}[1]{\setcounter{spelllevel}{0}\renewcommand{\currentsphere}{#1}\index{#1}\section{\currentsphere}}
\newcommand{\spelllevel}{\addtocounter{spelllevel}{1}\subsection{\currentsphere~ Level \arabic{spelllevel}}\noindent}
\newcommand{\enhancement}[2]{\paragraph{(#1) #2:}}

\newcommand{\spell}[3]{\subsubsection{#1}

{\it Type: #2, Skill: #3}

\noindent}

% Toggles for knacks

%%%%%%%%%%%%%%%%%%%% Environments %%%%%%%%%%%%%%%%%%%%
\newenvironment{boxtext}{\begin{quotation}\noindent}{\end{quotation}}

\newenvironment{speechtext}{\begin{quotation}\noindent}{\end{quotation}}

\tcolorboxenvironment{boxtext}{}
\tcolorboxenvironment{speechtext}{}

\newenvironment{rolltable}%
{\vspace{.3cm}\begin{tabular}{|lp{.8\textwidth}}


Roll & Result \\
\hline

}%
{\end{tabular}}


\newenvironment{exampletext}{\needspace{4cm}\vspace{.3cm}

\rule{.9\linewidth}{0.2pt}

\vspace{.3cm}

\it}{\normalfont}

\newtcolorbox{xpchart}[1]{tabularx={l|p{.8\textwidth}},arc=0mm,adjusted title=XP Rewards for #1}

\newtcolorbox[use counter=enc, use counter=list]{encounters}[1]{adjusted title=Encounters in #1,arc=1mm,tabularx={XXp{.7\textwidth}},code={\setcounter{enc}{19}\setcounter{list}{18}}}

\newtcolorbox{rollchart}{tabularx={cp{.84\textwidth}},arc=1mm}

\newtcolorbox{xpbox}[1]{tabularx={lc},arc=1mm,equal height group=#1}


%%%%%%%%%%%%%%%%%%% COMMANDS %%%%%%%%%%%%%%%%%%%%

\newcommand{\story}[2]{\needspace{2em}\vspace{.3cm}\noindent\textbf{#2\ldots}\par\noindent Cost: #1\par\noindent}

\newcommand{\best}[1]{\subsubsection{#1}\index{#1}}

%%% Random Number by grabbing last page digit
\newcounter{random}

\newcommand{\random}{
	\addtocounter{random}{\value{page}}\addtocounter{random}{1}
	\multiply\value{random} by \value{chapter}
	\whileboolexpr{
		test {\ifnumcomp{\value{random}}{>}{10}}
	}
	{\addtocounter{random}{-10}}
	{\setcounter{age}{\value{random}}}
}

\newcommand{\randomthree}{
	\random
	\whileboolexpr{
		test {\ifnumcomp{\value{random}}{>}{3}}
		}
		{\addtocounter{random}{-3}}
		{\setcounter{age}{\value{random}}}
}

\newcommand{\randomtwo}{
	\random
	\whileboolexpr{
		test {\ifnumcomp{\value{random}}{>}{2}}
		}
		{\addtocounter{random}{-2}}
		{\setcounter{enc}{\value{random}}}
}

\newcommand{\mapentry}[1]{\addtocounter{list}{1}\subsubsection{\arabic{list}: #1}}
\newcommand{\li}{\addtocounter{enc}{-1}\arabic{enc}&}
\newcommand{\lii}{\addtocounter{list}{-1}\arabic{list}&}
\newcounter{gold}

%%%%% Side Quests

\newcommand{\sidequest}[1]{\subsection[#1]{#1 -- \encnum}}
\newcommand{\forest}[1]{\subsection{(\ding{168} Forest) #1}}
\newcommand{\town}[1]{\subsection{(\ding{169} Town) #1}}
\newcommand{\villages}[1]{\subsection{(\ding{170} Villages) #1}}
\newcommand{\lowercollege}[1]{\subsection{(\ding{170} Lower College) #1}}
\newcommand{\uppercollege}[1]{\subsection{(\ding{171} Upper College) #1}}
